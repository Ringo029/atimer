<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Kitchen Multi-Timer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#003366">
  <meta name="description" content="A powerful, retro-style kitchen timer.">
  
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">

  <style>
    /* --- RETRO THEME BASE --- */
    body {
      margin: 0;
      padding: 0;
      background-color: #003366;
      font-family: Verdana, Arial, sans-serif;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    #page {
      max-width: 500px;
      margin: 0 auto;
      background-color: #d4d0c8;
      border: 2px solid #ffffff;
      border-right-color: #404040;
      border-bottom-color: #404040;
      padding: 10px;
      box-sizing: border-box;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      background: #003366;
      border: 2px inset #ffffff;
      padding: 5px;
    }

    h1 {
      font-size: 18px;
      margin: 0;
      color: white;
      text-align: center;
      flex-grow: 1;
    }

    #wakeStatus {
      font-size: 10px;
      color: #aaa;
      border: 1px solid #aaa;
      padding: 2px 4px;
      margin-left: 10px;
      display: none;
    }
    #wakeStatus.active {
      display: block;
      color: #00ff00;
      border-color: #00ff00;
      font-weight: bold;
    }

    /* --- COOKBOOK SECTION --- */
    #cookbook {
      margin-bottom: 15px;
      border: 1px solid #777;
      padding: 8px;
      background: #e0e0e0;
    }
    .cookbook-title {
      font-size: 12px;
      font-weight: bold;
      margin-bottom: 5px;
      color: #333;
      text-transform: uppercase;
    }
    #presetList {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
    }
    .chip {
      background: #003366;
      color: white;
      padding: 4px 8px;
      font-size: 11px;
      border-radius: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      box-shadow: 1px 1px 3px rgba(0,0,0,0.3);
    }
    .chip:active { transform: translateY(1px); }
    .chip-del {
      font-weight: bold;
      color: #ff9999;
      padding: 0 4px;
    }

    /* --- TIMER CARDS --- */
    .timer {
      border: 2px solid #404040;
      border-right-color: #ffffff;
      border-bottom-color: #ffffff;
      padding: 8px;
      margin-bottom: 12px;
      background-color: #c0c0c0;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
    }

    @keyframes flashRed {
      0%, 100% { background-color: #ff0000; }
      50% { background-color: #ffffff; }
    }
    .timer.alarm-active { animation: flashRed 1s infinite; border: 2px solid red; }

    /* Label Row */
    .label-row { display: flex; gap: 5px; margin-bottom: 4px; }
    .timer-label input {
      flex-grow: 1;
      width: 100%;
      box-sizing: border-box;
      padding: 5px;
      font-weight: bold;
      border: 2px inset #fff;
    }
    .btn-save {
      font-size: 14px;
      padding: 0 8px;
      cursor: pointer;
    }

    /* Display */
    .timer-display {
      background-color: #000;
      color: #00ff00;
      font-family: "Courier New", monospace;
      font-size: 32px;
      text-align: center;
      padding: 5px;
      margin: 8px 0;
      border: 2px inset #808080;
      font-weight: bold;
      letter-spacing: 2px;
    }
    .timer.alarm-active .timer-display { color: #ff0000; background-color: #fff; }

    /* Controls */
    .timer-controls { display: flex; gap: 5px; justify-content: center; }
    .quick-add { margin-top: 5px; text-align: center; display: flex; justify-content: center; gap: 2px; }

    button {
      font-family: Tahoma, sans-serif;
      font-size: 13px;
      background: #d4d0c8;
      border: 2px solid #fff;
      border-right-color: #404040;
      border-bottom-color: #404040;
      padding: 5px 10px;
      cursor: pointer;
      font-weight: bold;
      color: black;
      touch-action: manipulation;
    }
    button:active { border-style: solid; border-width: 2px; border-color: #404040 #fff #fff #404040; transform: translateY(1px); }
    button:disabled { color: #888; border-color: #999; cursor: not-allowed; }

    .btn-big { font-size: 14px; padding: 8px 16px; min-width: 80px; flex-grow: 1; }
    .btn-reset, .btn-del { font-size: 11px; }
    .btn-quick { font-size: 11px; padding: 4px 8px; flex-grow: 1; }

    #addTimerWrapper { text-align: center; margin-top: auto; padding-top: 20px; }
    #addTimerBtn { font-size: 16px; padding: 10px 20px; width: 100%; }

    @media (min-width: 600px) {
      #page { margin-top: 20px; margin-bottom: 20px; }
      #addTimerBtn { width: auto; }
    }
  </style>
</head>
<body>

<div id="page">
  <div class="header-row">
    <h1>‚è≤ A Timer.</h1>
    <div id="wakeStatus">NO SLEEP ON</div>
  </div>

  <div id="cookbook">
    <div class="cookbook-title">Cookbook (Saved Timers)</div>
    <div id="presetList">
      </div>
    <div id="emptyCookbookMsg" style="font-size:10px; color:#666; font-style:italic; margin-top:4px;">
      Set a timer below and click üíæ to save it here.
    </div>
  </div>
  
  <div id="timers"></div>

  <div id="addTimerWrapper">
    <button id="addTimerBtn">+ New Timer</button>
  </div>
</div>

<script>
  // --- SERVICE WORKER REGISTRATION (Offline Capability) ---
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('sw.js')
        .then(reg => console.log('SW Registered'))
        .catch(err => console.log('SW Error:', err));
    });
  }

  (function () {
    const timersContainer = document.getElementById('timers');
    const addBtn = document.getElementById('addTimerBtn');
    const wakeStatus = document.getElementById('wakeStatus');
    const presetList = document.getElementById('presetList');
    const emptyMsg = document.getElementById('emptyCookbookMsg');
    
    let timersState = []; 
    let presets = [];
    let audioCtx = null;
    let wakeLock = null;

    // --- AUDIO & WAKE LOCK (Same as before) ---
    function initAudio() {
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      if (audioCtx.state === 'suspended') audioCtx.resume();
    }

    function playBeep() {
      if (!audioCtx) return;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = 'square';
      osc.frequency.setValueAtTime(880, audioCtx.currentTime); 
      osc.frequency.setValueAtTime(440, audioCtx.currentTime + 0.1); 
      gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.5);
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      osc.start();
      osc.stop(audioCtx.currentTime + 0.5);
    }

    async function requestWakeLock() {
      if ('wakeLock' in navigator) {
        try {
          wakeLock = await navigator.wakeLock.request('screen');
          wakeStatus.classList.add('active');
        } catch (err) {}
      }
    }
    function releaseWakeLock() {
      if (wakeLock !== null) {
        wakeLock.release().then(() => { wakeLock = null; wakeStatus.classList.remove('active'); });
      }
    }
    function updateWakeLockState() {
      const anyRunning = timersState.some(t => t.isRunning || t.isAlarming);
      if (anyRunning && !wakeLock) requestWakeLock();
      else if (!anyRunning && wakeLock) releaseWakeLock();
    }
    document.addEventListener('visibilitychange', async () => {
      if (wakeLock !== null && document.visibilityState === 'visible') requestWakeLock();
    });

    // --- STORAGE & COOKBOOK ---
    function saveTimers() { localStorage.setItem('kitchenTimers', JSON.stringify(timersState)); }
    function savePresets() { localStorage.setItem('kitchenCookbook', JSON.stringify(presets)); }

    function loadData() {
      // Load Timers
      const storedTimers = localStorage.getItem('kitchenTimers');
      if (storedTimers) {
        try {
          const parsed = JSON.parse(storedTimers);
          parsed.forEach(tData => {
            if (tData.isRunning && tData.targetEndTime) {
              const now = Date.now();
              const remaining = Math.ceil((tData.targetEndTime - now) / 1000);
              if (remaining <= 0) {
                tData.timeLeft = 0; tData.isRunning = false; tData.isAlarming = true;
              } else {
                tData.timeLeft = remaining;
              }
            }
            createTimer(tData);
          });
        } catch (e) {}
      } else {
        createTimer();
      }

      // Load Presets
      const storedPresets = localStorage.getItem('kitchenCookbook');
      if (storedPresets) {
        try { presets = JSON.parse(storedPresets); } catch(e) {}
      }
      renderPresets();
    }

    function renderPresets() {
      presetList.innerHTML = '';
      if (presets.length === 0) {
        emptyMsg.style.display = 'block';
      } else {
        emptyMsg.style.display = 'none';
        presets.forEach((p, index) => {
          const chip = document.createElement('div');
          chip.className = 'chip';
          chip.innerHTML = `<span>${p.label} (${formatTime(p.seconds)})</span>`;
          
          // Delete button inside chip
          const del = document.createElement('span');
          del.className = 'chip-del';
          del.innerHTML = '&times;';
          del.onclick = (e) => {
            e.stopPropagation();
            if(confirm(`Remove "${p.label}" from cookbook?`)) {
              presets.splice(index, 1);
              savePresets();
              renderPresets();
            }
          };

          chip.appendChild(del);
          chip.onclick = () => {
            createTimer({ 
              id: Date.now().toString(), 
              label: p.label, 
              timeLeft: p.seconds, 
              originalTime: p.seconds, 
              isRunning: false, 
              isAlarming: false, 
              targetEndTime: null 
            });
          };
          presetList.appendChild(chip);
        });
      }
    }

    function addToCookbook(label, seconds) {
      if (seconds <= 0) return alert("Set a time first!");
      const name = label || "Untitled";
      presets.push({ label: name, seconds: seconds });
      savePresets();
      renderPresets();
    }

    // --- HELPER FUNCTIONS ---
    function pad(n) { return n < 10 ? '0' + n : '' + n; }
    function formatTime(totalSeconds) {
      if (totalSeconds < 0) totalSeconds = 0;
      const h = Math.floor(totalSeconds / 3600);
      const m = Math.floor((totalSeconds % 3600) / 60);
      const s = totalSeconds % 60;
      if (h > 0) return `${h}:${pad(m)}:${pad(s)}`;
      return `${pad(m)}:${pad(s)}`;
    }
    function updatePageTitle() {
        const runningTimers = timersState.filter(t => t.isRunning);
        if (runningTimers.length > 0) {
            const minTime = Math.min(...runningTimers.map(t => t.timeLeft));
            document.title = `(${formatTime(minTime)}) A Timer.`;
        } else {
            document.title = "A Timer.";
        }
    }

    // --- TIMER FACTORY ---
    function createTimer(dataObj = null) {
      const timerId = dataObj ? dataObj.id : Date.now().toString();
      const state = dataObj || {
        id: timerId, label: '', timeLeft: 0, originalTime: 0, 
        isRunning: false, isAlarming: false, targetEndTime: null 
      };

      if (!dataObj) { timersState.push(state); saveTimers(); }
      else { if (!timersState.find(t => t.id === state.id)) timersState.push(state); }

      const wrapper = document.createElement('div');
      wrapper.className = 'timer';
      if(state.isAlarming) wrapper.classList.add('alarm-active');

      // 1. Label Row (Input + Save Button)
      const labelRow = document.createElement('div');
      labelRow.className = 'label-row';
      const labelDiv = document.createElement('div');
      labelDiv.className = 'timer-label';
      labelDiv.style.flexGrow = "1";
      
      const labelInput = document.createElement('input');
      labelInput.type = 'text';
      labelInput.placeholder = 'Label (e.g. Rice)';
      labelInput.value = state.label;
      labelInput.oninput = (e) => { state.label = e.target.value; saveTimers(); };
      
      const saveBtn = document.createElement('button');
      saveBtn.className = 'btn-save';
      saveBtn.innerHTML = 'üíæ';
      saveBtn.title = "Save to Cookbook";
      saveBtn.onclick = () => addToCookbook(state.label, state.originalTime > 0 ? state.originalTime : state.timeLeft);

      labelDiv.appendChild(labelInput);
      labelRow.appendChild(labelDiv);
      labelRow.appendChild(saveBtn);

      const display = document.createElement('div');
      display.className = 'timer-display';
      display.innerText = state.isAlarming ? "DONE!" : formatTime(state.timeLeft);

      const quickAddDiv = document.createElement('div');
      quickAddDiv.className = 'quick-add';
      const makeQuickBtn = (txt, time) => {
        const b = document.createElement('button');
        b.className = 'btn-quick'; b.innerText = txt;
        b.onclick = () => addTime(time);
        return b;
      };
      const clrBtn = document.createElement('button');
      clrBtn.className = 'btn-quick'; clrBtn.innerText = 'Clr';
      clrBtn.onclick = () => { if(!state.isRunning && !state.isAlarming) { state.timeLeft = 0; state.originalTime = 0; updateDisplay(); } };
      quickAddDiv.append(makeQuickBtn('+1m', 60), makeQuickBtn('+5m', 300), makeQuickBtn('+10m', 600), clrBtn);

      const controlsDiv = document.createElement('div');
      controlsDiv.className = 'timer-controls';
      const startBtn = document.createElement('button');
      startBtn.className = 'btn-big';
      startBtn.innerText = state.isRunning ? 'PAUSE' : (state.isAlarming ? 'STOP ALARM' : 'START');
      const resetBtn = document.createElement('button');
      resetBtn.className = 'btn-reset';
      resetBtn.innerText = 'Reset';
      if(state.isAlarming) resetBtn.disabled = true;
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'btn-del';
      deleteBtn.innerText = 'X';
      controlsDiv.append(startBtn, resetBtn, deleteBtn);

      wrapper.append(labelRow, display, quickAddDiv, controlsDiv);
      timersContainer.appendChild(wrapper);

      let localInterval = null;
      let alarmInterval = null;

      function updateDisplay() {
        if(state.isAlarming) {
            display.innerText = "DONE!";
            wrapper.classList.add('alarm-active');
            startBtn.innerText = "STOP ALARM";
            resetBtn.disabled = true;
        } else {
            display.innerText = formatTime(state.timeLeft);
            wrapper.classList.remove('alarm-active');
            startBtn.innerText = state.isRunning ? "PAUSE" : "START";
            resetBtn.disabled = false;
        }
        saveTimers();
        updatePageTitle();
        updateWakeLockState();
      }

      function addTime(seconds) {
        if (!state.isRunning && !state.isAlarming) {
          state.timeLeft += seconds;
          state.originalTime = state.timeLeft; 
          updateDisplay();
        }
      }

      function startTimer() {
        if(state.timeLeft <= 0) return;
        initAudio();
        state.isRunning = true;
        state.targetEndTime = Date.now() + (state.timeLeft * 1000);
        
        localInterval = setInterval(() => {
          const now = Date.now();
          const remaining = Math.ceil((state.targetEndTime - now) / 1000);
          if (remaining <= 0) {
             state.timeLeft = 0;
             stopTimer();
             triggerAlarm();
          } else {
             if (state.timeLeft !== remaining) {
                 state.timeLeft = remaining;
                 display.innerText = formatTime(state.timeLeft);
                 updatePageTitle();
             }
          }
        }, 200);
        updateDisplay();
      }

      function stopTimer() {
        state.isRunning = false;
        state.targetEndTime = null;
        if(localInterval) clearInterval(localInterval);
        updateDisplay();
      }

      function triggerAlarm() {
        state.isAlarming = true;
        updateDisplay();
        playBeep();
        alarmInterval = setInterval(playBeep, 1000);
        window.focus();
      }

      function stopAlarm() {
        state.isAlarming = false;
        if(alarmInterval) clearInterval(alarmInterval);
        state.timeLeft = 0;
        updateDisplay();
      }

      startBtn.onclick = () => {
        if (state.isAlarming) stopAlarm();
        else if (state.isRunning) stopTimer();
        else startTimer();
      };
      resetBtn.onclick = () => {
        if(!state.isRunning && !state.isAlarming) { state.timeLeft = state.originalTime; updateDisplay(); }
      };
      deleteBtn.onclick = () => {
        if(confirm('Delete this timer?')) {
          stopTimer(); stopAlarm();
          timersState = timersState.filter(t => t.id !== state.id);
          saveTimers();
          wrapper.remove();
          updatePageTitle();
          updateWakeLockState();
        }
      };

      if (state.isRunning) startTimer();
      if (state.isAlarming) triggerAlarm();
    }

    addBtn.onclick = () => createTimer();
    loadData();
  })();
</script>
</body>
</html>